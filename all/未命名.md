```mermaid
title: 学生成绩管理与分析系统 - 业务流程图

start: 开始
io: 启动程序
proc: 尝试从 data.json 加载数据
decision: 加载成功？
proc_ok: 进入主循环
proc_fail: 提示错误并以空数据启动

menu: 显示主菜单
decision_menu: 用户选择？
m1: 进入「学生信息管理」子菜单
m2: 进入「成绩管理」子菜单
m3: 进入「查询/排名/统计」子菜单
m4: 进入「导入/导出/备份」子菜单
m5: 进入「数据可视化」菜单
m0: 选择「保存并退出」
melse: 无效选择提示

decision_dirty: 数据是否被修改(dirty)？
proc_save: 保存前自动备份 -> 原子写入保存 data.json
end: 结束

# 学生信息管理
stu_menu: 显示学生管理菜单
stu_choice: 选择学生管理功能？
stu_add: 添加学生
stu_add_in: 输入 学号/姓名/班级
stu_add_check: 学号是否已存在？
stu_add_ok: 写入学生记录并标记 dirty=True
stu_add_bad: 提示 学号已存在

stu_upd: 修改学生
stu_upd_in: 输入 要修改的学号 -> 获取学生
stu_upd_fields: 输入 新学号/新姓名/新班级
stu_upd_check: 新学号冲突？
stu_upd_ok: 更新信息并标记 dirty=True
stu_upd_bad: 提示 新学号已存在

stu_del: 删除学生
stu_del_in: 输入 学号 -> 获取学生
stu_del_confirm: 二次确认 y/N？
stu_del_ok: 删除学生并标记 dirty=True
stu_del_cancel: 取消删除

stu_query: 查询学生
stu_query_in: 输入 学号(可选)/姓名关键字(可选)/班级(可选)
stu_query_out: 输出表格结果或提示未找到

stu_list: 列出全部学生
stu_list_out: 输出表格或提示暂无数据
stu_back: 返回主菜单

# 成绩管理
score_menu: 显示成绩管理菜单
score_choice: 选择成绩管理功能？
score_set: 录入/修改成绩
score_set_in: 输入 学号/科目/分数
score_set_check: 分数是否在 0-100？
score_set_ok: 写入/覆盖成绩并标记 dirty=True
score_set_bad: 提示分数范围错误并重新输入

score_rm: 删除某科成绩
score_rm_in: 输入 学号/科目
score_rm_exist: 科目是否存在？
score_rm_ok: 删除成绩并标记 dirty=True
score_rm_bad: 提示该科目不存在

score_view: 查看某学生成绩
score_view_in: 输入 学号
score_view_out: 输出成绩明细/总分/均分 或提示暂无成绩
score_back: 返回主菜单

# 查询/排名/统计
ana_menu: 显示分析统计菜单
ana_choice: 选择分析功能？
ana_rank: 查看排名
ana_rank_in: 输入 班级(可选)
ana_rank_out: 输出排名表(密集排名)

ana_subj: 科目统计
ana_subj_in: 输入 科目 + 班级(可选)
ana_subj_out: 输出 count/max/min/mean/std

ana_total: 总分统计
ana_total_in: 输入 班级(可选)
ana_total_out: 输出 count/max/min/mean/std
ana_back: 返回主菜单

# 导入/导出/备份
file_menu2: 显示文件操作菜单
file_choice: 选择文件功能？
exp_json: 导出 JSON
exp_json_in: 输入导出路径
exp_json_do: 原子写入导出文件

imp_json: 导入 JSON(合并)
imp_json_in: 输入导入路径 + 合并策略 overwrite/skip
imp_json_do: 导入并合并 -> 输出新增/更新数 -> 标记 dirty=True

exp_csv: 导出 CSV(长表)
exp_csv_in: 输入导出路径
exp_csv_do: 写入 CSV 文件

imp_csv: 导入 CSV(合并)
imp_csv_in: 输入导入路径 + 合并策略
imp_csv_do: 导入并合并 -> 输出新增/更新数 -> 标记 dirty=True
file_back: 返回主菜单

# 可视化
viz_menu2: 显示可视化菜单
viz_choice: 选择绘图功能？
viz_check: 是否安装 matplotlib？
viz_no: 提示未安装并返回
viz_hist_total: 绘制总分直方图
viz_hist_subj: 输入科目并绘制直方图
viz_cmp_total: 绘制班级对比(总分均值)
viz_cmp_subj: 输入科目并绘制班级对比(科目均值)
viz_back: 返回主菜单

# 全局异常处理
err: 捕获异常并提示 操作失败

# 连接主流程
start -> io -> proc -> decision
decision -> proc_ok: 是
decision -> proc_fail: 否
proc_fail -> proc_ok

proc_ok -> menu -> decision_menu
decision_menu -> m1: 1
decision_menu -> m2: 2
decision_menu -> m3: 3
decision_menu -> m4: 4
decision_menu -> m5: 5
decision_menu -> m0: 0
decision_menu -> melse: 其他

melse -> menu

m0 -> decision_dirty
decision_dirty -> proc_save: 是
decision_dirty -> end: 否
proc_save -> end

# 学生子流程
m1 -> stu_menu -> stu_choice
stu_choice -> stu_add: 1
stu_choice -> stu_upd: 2
stu_choice -> stu_del: 3
stu_choice -> stu_query: 4
stu_choice -> stu_list: 5
stu_choice -> stu_back: 0
stu_choice -> err: 其他异常

stu_add -> stu_add_in -> stu_add_check
stu_add_check -> stu_add_ok: 否
stu_add_check -> stu_add_bad: 是
stu_add_bad -> stu_menu
stu_add_ok -> stu_menu

stu_upd -> stu_upd_in -> stu_upd_fields -> stu_upd_check
stu_upd_check -> stu_upd_bad: 是
stu_upd_check -> stu_upd_ok: 否
stu_upd_bad -> stu_menu
stu_upd_ok -> stu_menu

stu_del -> stu_del_in -> stu_del_confirm
stu_del_confirm -> stu_del_ok: y
stu_del_confirm -> stu_del_cancel: 其他
stu_del_ok -> stu_menu
stu_del_cancel -> stu_menu

stu_query -> stu_query_in -> stu_query_out -> stu_menu
stu_list -> stu_list_out -> stu_menu
stu_back -> menu

# 成绩子流程
m2 -> score_menu -> score_choice
score_choice -> score_set: 1
score_choice -> score_rm: 2
score_choice -> score_view: 3
score_choice -> score_back: 0
score_choice -> err: 其他异常

score_set -> score_set_in -> score_set_check
score_set_check -> score_set_ok: 是
score_set_check -> score_set_bad: 否
score_set_bad -> score_set_in
score_set_ok -> score_menu

score_rm -> score_rm_in -> score_rm_exist
score_rm_exist -> score_rm_ok: 是
score_rm_exist -> score_rm_bad: 否
score_rm_bad -> score_menu
score_rm_ok -> score_menu

score_view -> score_view_in -> score_view_out -> score_menu
score_back -> menu

# 分析子流程
m3 -> ana_menu -> ana_choice
ana_choice -> ana_rank: 1
ana_choice -> ana_subj: 2
ana_choice -> ana_total: 3
ana_choice -> ana_back: 0
ana_choice -> err: 其他异常

ana_rank -> ana_rank_in -> ana_rank_out -> ana_menu
ana_subj -> ana_subj_in -> ana_subj_out -> ana_menu
ana_total -> ana_total_in -> ana_total_out -> ana_menu
ana_back -> menu

# 文件子流程
m4 -> file_menu2 -> file_choice
file_choice -> exp_json: 1
file_choice -> imp_json: 2
file_choice -> exp_csv: 3
file_choice -> imp_csv: 4
file_choice -> file_back: 0
file_choice -> err: 其他异常

exp_json -> exp_json_in -> exp_json_do -> file_menu2
imp_json -> imp_json_in -> imp_json_do -> file_menu2
exp_csv -> exp_csv_in -> exp_csv_do -> file_menu2
imp_csv -> imp_csv_in -> imp_csv_do -> file_menu2
file_back -> menu

# 可视化子流程
m5 -> viz_menu2 -> viz_choice
viz_choice -> viz_check: 1/2/3/4
viz_choice -> viz_back: 0
viz_choice -> err: 其他异常

viz_check -> viz_no: 否
viz_check -> viz_hist_total: 是(选1)
viz_check -> viz_hist_subj: 是(选2)
viz_check -> viz_cmp_total: 是(选3)
viz_check -> viz_cmp_subj: 是(选4)

viz_no -> viz_menu2
viz_hist_total -> viz_menu2
viz_hist_subj -> viz_menu2
viz_cmp_total -> viz_menu2
viz_cmp_subj -> viz_menu2

viz_back -> menu

# 异常回流
err -> menu
```